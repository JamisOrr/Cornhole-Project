<!DOCTYPE html>
<html>

<head>
    <title>Playing Game</title>
    <style>
        .rh {
            color: black;
            float: left;
            clear: left;
        }

        .bh {
            color: black;
            float: left;
        }

        .bleck {
            color: black;
            float: left;
            padding-left: 100px;
            padding-right: 100px;

        }

        .bottomPadding {
            float: left;
            clear: left;
        }

        .f {
            float: left;
            padding-left: 5px;
        }

        .hee {
            padding-bottom: 25px;
        }

        .him {
            clear: left;
        }

        .r {
            color: black;
            float: left;
            clear: left;
        }

        .b {
            float: left;
            color: black;
            padding-left: 150px;
        }

        .ra {
            color: black;
            background-color: white;
            float: left;
            clear: left;
            padding-left: 50px;
            padding-right: 50px;
        }

        .ba {
            float: left;
            color: white;
            background-color: black;
            padding-left: 50px;
            padding-right: 50px;
        }
    </style>
</head>

<body>
    <h1>Live Score</h1>
    <h2 class="him" id="firstup"></h2>
    <img src="red.jpg" alt="White Circle" width="150" height="150">
    <img src="blue.jpg" alt="Blue X" width="100" height="100" class="hee">
    <br>
    <input class="ra" type="button" id="rpt" value="+1" onclick="rp()">
    <input class="ba" type="button" id="bpt" value="+1" onclick="bp()">
    <h2 id="rscore" class="rh">0</h2>
    <h2 class="bleck">-</h2>
    <h2 id="bscore" class="bh">0</h2>
    <h2 class="r" id="rn"></h2>
    <h2 class="b" id="bn"></h2>
    <h2 class="bottomPadding">Round: </h2>
    <h2 class="f" id="round"> 0</h2>
    <input type="button" value="press" onclick="init()">
</body>
<script>
    var data = localStorage.gameInfo;
    const info = data.split("|");
    document.getElementById("rn").innerText = info[1];
    document.getElementById("bn").innerText = info[2];
    var score = info[3];
    if (info[0] == "white") {
        document.getElementById("firstup").innerText = "White is First Up";
        //  document.getElementById("firstup").style.color = "#ff0000";
    } else {
        document.getElementById("firstup").innerText = "Black is First Up";
        //  document.getElementById("firstup").style.color = "#0000ff";
    }
    const date = new Date().toDateString();

    function rp() {
        white++;
        document.getElementById("rscore").innerText = white;
        checkscore();
    }
    function bp() {
        black++;
        document.getElementById("bscore").innerText = black;
        checkscore();
    }
    function checkscore() {
        if (white == score || black == score) {
            var f = info[1] + "|" + white + "|" + info[2] + "|" + black + "|" + date;
            if (localStorage.gh == "") {
                localStorage.gh = f;
            } else {
                localStorage.gh = "~" + f;
            }
            if (rscore == score) {
                localStorage.go = "white";
            } else {
                localStorage.go = "black";
            }
            location.replace("./gameover.html");
        }
    }
    var dataArray = new Array(
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0]
    );
    var prevDataArray = new Array(
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0]
    );
    var s = false;
    var col = 0;
    var row = 0;
    var white = 0;
    var black = 0;
    async function init() {
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        while (port.readable) {
            const textDecoder = new TextDecoderStream();
            const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();
            while (true) {
                const { value, done } = await reader.read();
                if (value) {
                    const str = value;
                    for (const char of str) {
                        if (char == "s") {
                            if (s) {
                                row = 0;
                                col = 0;
                                s = false;
                            } else {
                                s = true;
                            }
                        }
                        if (s) {
                            if (char != 's' && char != 't') {
                                dataArray[row][col] = char;
                                col++;
                                if (col == 7) {
                                    col = 0
                                    row++;
                                }
                            }
                        } else {
                            var arrayDisplayString = "";
                            for (var q = 0; q < 14; q++) {
                                for (var w = 0; w < 7; w++) {
                                    arrayDisplayString += dataArray[q][w] + " ";
                                }
                                arrayDisplayString += "\n"
                            }
                            var newSensedWhite = false;
                            var missingSensedWhite = false;
                            var newSensedBlack = false;
                            var missingSensedBlack = false;
                            for (var i = 0; i < 14; i++) {
                                for (var j = 0; j < 7; j++) {
                                    if (dataArray[i][j] != prevDataArray[i][j]) {
                                        if (dataArray[i][j] == 1 && !newSensedWhite) {
                                            white++;
                                            newSensedWhite = true;
                                        } else if (dataArray[i][j] == 2 && !newSensedBlack) {
                                            black++;
                                            newSensedBlack = true;
                                        } else if (dataArray[i][j] == 0) {
                                            if (prevDataArray[i][j] == 1 && !missingSensedWhite) {
                                                white--;
                                                missingSensedWhite = true;
                                            } else if (prevDataArray[i][j] == 2 && !missingSensedBlack) {
                                                black--;
                                                missingSensedBlack = true;
                                            }
                                        }
                                    }
                                }
                            }
                            document.getElementById("rscore").innerText = white;
                            document.getElementById("bscore").innerText = black;
                            //document.getElementById("scoreDisplayObject").innerText = (white + " " + black);
                            //console.log(white + " " + black);
                            for (var i = 0; i < 14; i++) {
                                for (var j = 0; j < 7; j++) {
                                    prevDataArray[i][j] = dataArray[i][j];
                                }
                            }
                        }
                    };
                }

            }
        }
        console.log("not readable");
        await port.close();
    }
</script>

</html>